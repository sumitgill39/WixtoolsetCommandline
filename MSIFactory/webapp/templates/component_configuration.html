{% extends "base_sidebar.html" %}

{% block title %}Component Configuration - MSI Factory{% endblock %}
{% block page_title %}Component Configuration{% endblock %}

{% block content %}
<style>
    /* Card-based Layout */
    .components-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
        padding: 15px 0;
    }
    
    .component-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
        border: 1px solid #e0e0e0;
    }
    
    .component-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-color: #87ceeb;
    }
    
    .component-card.expanded {
        grid-column: 1/-1;
        cursor: default;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }
    
    /* Card Header with Light Sky Blue */
    .card-header {
        background: #87ceeb;
        padding: 12px 15px;
        position: relative;
        overflow: hidden;
    }
    
    .card-header.webapp {
        background: #87ceeb;
    }
    
    .card-header.api {
        background: #87ceeb;
    }
    
    .card-header.service {
        background: #87ceeb;
    }
    
    .card-header.desktop {
        background: #87ceeb;
    }
    
    .card-header.library {
        background: #87ceeb;
    }
    
    /* Card Header Content */
    .card-title {
        color: white;
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .component-number {
        background: rgba(255, 255, 255, 0.2);
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .card-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.75rem;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Status Ribbon */
    .status-ribbon {
        position: absolute;
        top: 8px;
        right: -30px;
        transform: rotate(45deg);
        width: 120px;
        padding: 3px 0;
        text-align: center;
        font-size: 0.65rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .status-ribbon.configured {
        background: #4682b4;
    }
    
    .status-ribbon.pending {
        background: #87ceeb;
    }
    
    /* Card Body */
    .card-body {
        padding: 12px;
        background: #f8f9fa;
    }
    
    .info-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .info-item {
        background: white;
        padding: 6px 10px;
        border-radius: 5px;
        border-left: 2px solid #87ceeb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        flex-wrap: wrap;
        gap: 5px;
    }

    .info-item.guid-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .info-label {
        color: #000000;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .info-value {
        color: #000000;
        font-weight: 500;
        font-size: 0.8rem;
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .guid-value {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.65rem;
        background: #ecf0f1;
        padding: 1px 4px;
        border-radius: 3px;
        color: #000000;
        max-width: none !important;
        overflow: visible !important;
        text-overflow: clip !important;
        word-break: break-all;
        white-space: normal;
    }
    
    /* Tags Section */
    .tags-section {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e0e0e0;
    }
    
    .tag {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 3px;
    }
    
    .tag i {
        font-size: 0.6rem;
    }
    
    .tag-project {
        background: #e0f6ff;
        color: #000000;
    }
    
    .tag-framework {
        background: #e0f6ff;
        color: #000000;
    }
    
    .tag-type {
        background: #e0f6ff;
        color: #000000;
    }
    
    /* Action Buttons */
    .card-actions {
        padding: 10px 12px;
        background: white;
        border-top: 1px solid #ecf0f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }
    
    .configure-btn, .edit-btn {
        background: #4682b4;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        flex: 1;
        justify-content: center;
    }
    
    .configure-btn:hover, .edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(70, 130, 180, 0.3);
        background: #5a9bd4;
    }
    
    .view-details-btn {
        background: transparent;
        color: #4682b4;
        border: 1px solid #4682b4;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s ease;
        flex: 1;
        text-align: center;
    }
    
    .view-details-btn:hover {
        background: #4682b4;
        color: white;
    }
    
    /* Expanded Configuration Form */
    .config-panel {
        display: none;
        padding: 20px;
        background: white;
        border-top: 2px solid #ecf0f1;
    }
    
    .component-card.expanded .config-panel {
        display: block;
    }
    
    .form-section {
        margin-bottom: 20px;
    }
    
    .form-section h5 {
        color: #000000;
        font-size: 0.9rem;
        margin: 0 0 12px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid #ecf0f1;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        color: #000000;
        font-size: 0.85rem;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        color: #000000;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #87ceeb;
        box-shadow: 0 0 0 3px rgba(135, 206, 235, 0.1);
    }
    
    /* Save Button */
    .save-config-btn {
        background: #4682b4;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 15px;
    }
    
    .save-config-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(70, 130, 180, 0.3);
        background: #5a9bd4;
    }
    
    /* Filter and Search Bar */
    .filters-bar {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        border: 1px solid #e0e0e0;
    }
    
    .search-group {
        flex: 1;
        min-width: 200px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 8px 10px 8px 35px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.85rem;
        color: #000000;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #87ceeb;
        box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #000000;
        font-size: 0.85rem;
    }
    
    .filter-chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .filter-chip {
        background: #ecf0f1;
        border: none;
        padding: 5px 10px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        color: #000000;
    }
    
    .filter-chip:hover {
        background: #87ceeb;
        color: white;
    }
    
    .filter-chip.active {
        background: #4682b4;
        color: white;
    }
    
    /* Statistics Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
    }
    
    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        text-align: center;
        border: 1px solid #e0e0e0;
    }
    
    .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #000000;
        margin: 0;
    }
    
    .stat-label {
        color: #000000;
        font-size: 0.75rem;
        margin-top: 3px;
    }
    
    /* Loading Animation */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .loading {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .components-grid {
            grid-template-columns: 1fr;
        }
        
        .component-card.expanded {
            grid-column: span 1;
        }
    }
</style>

<!-- Statistics Row -->
<div class="stats-row">
    <div class="stat-card">
        <h3 class="stat-number">{{ components|length }}</h3>
        <p class="stat-label">Total Components</p>
    </div>
    <div class="stat-card">
        <h3 class="stat-number">{{ components|selectattr('config_id')|list|length }}</h3>
        <p class="stat-label">Configured</p>
    </div>
    <div class="stat-card">
        <h3 class="stat-number">{{ (components|length) - (components|selectattr('config_id')|list|length) }}</h3>
        <p class="stat-label">Pending Setup</p>
    </div>
    <div class="stat-card">
        <h3 class="stat-number">{{ components|map(attribute='project_name')|unique|list|length }}</h3>
        <p class="stat-label">Active Projects</p>
    </div>
</div>

<!-- Filters Bar -->
<div class="filters-bar">
    <div class="search-group">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="componentSearch" 
               placeholder="Search components, projects, or GUIDs..." 
               onkeyup="filterComponents()">
    </div>
    <div class="filter-chips">
        <button class="filter-chip active" onclick="filterByType('all')">All</button>
        <button class="filter-chip" onclick="filterByType('webapp')">Web Apps</button>
        <button class="filter-chip" onclick="filterByType('api')">APIs</button>
        <button class="filter-chip" onclick="filterByType('service')">Services</button>
        <button class="filter-chip" onclick="filterByStatus('configured')">Configured</button>
        <button class="filter-chip" onclick="filterByStatus('pending')">Pending</button>
    </div>
</div>

<!-- Components Grid -->
<div class="components-grid" id="componentsGrid">
    {% for component in components %}
    <div class="component-card" 
         data-component-id="{{ component.component_id }}" 
         data-component-type="{{ component.component_type|lower }}"
         data-component-name="{{ component.component_name|lower }}"
         data-project="{{ component.project_name|lower }}"
         data-status="{{ 'configured' if component.config_id else 'pending' }}">
        
        <!-- Card Header with Gradient -->
        <div class="card-header {{ component.component_type|lower }}">
            <h3 class="card-title">
                {{ component.component_name }}
                <span class="component-number">#{{ component.component_id }}</span>
            </h3>
            <p class="card-subtitle">{{ component.project_name }}</p>
            
            <!-- Status Ribbon -->
            <div class="status-ribbon {{ 'configured' if component.config_id else 'pending' }}">
                {{ 'Configured' if component.config_id else 'Needs Setup' }}
            </div>
        </div>
        
        <!-- Card Body -->
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item guid-item">
                    <span class="info-label">GUID</span>
                    <span class="info-value guid-value">{{ component.component_guid or 'Not Generated' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Version</span>
                    <span class="info-value">{{ component.app_version or '1.0.0.0' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Environment</span>
                    <span class="info-value">{{ component.target_environment or 'Not Set' }}</span>
                </div>
            </div>
            
            <!-- Tags -->
            <div class="tags-section">
                <span class="tag tag-project">
                    <i class="fas fa-folder"></i> {{ component.project_key }}
                </span>
                <span class="tag tag-type">
                    <i class="fas fa-cube"></i> {{ component.component_type }}
                </span>
                {% if component.framework %}
                <span class="tag tag-framework">
                    <i class="fas fa-code"></i> {{ component.framework }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Card Actions -->
        <div class="card-actions">
            <button class="configure-btn" onclick="toggleConfiguration({{ component.component_id }})">
                <i class="fas fa-cog"></i> Configure
            </button>
            <button class="view-details-btn" onclick="viewDetails({{ component.component_id }})">
                <i class="fas fa-eye"></i> Details
            </button>
        </div>
        
        <!-- Expanded Configuration Panel -->
        <div class="config-panel">
            <form id="config-form-{{ component.component_id }}" onsubmit="saveConfiguration(event, {{ component.component_id }})">
                <input type="hidden" name="component_id" value="{{ component.component_id }}">
                
                <!-- Basic MSI Settings -->
                <div class="form-section">
                    <h5><i class="fas fa-box"></i> MSI Package Settings</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Application Name</label>
                            <input type="text" name="app_name" value="{{ component.app_name or component.component_name }}" required>
                        </div>
                        <div class="form-group">
                            <label>Version</label>
                            <input type="text" name="app_version" value="{{ component.app_version or '1.0.0.0' }}" required>
                        </div>
                        <div class="form-group">
                            <label>Manufacturer</label>
                            <input type="text" name="manufacturer" value="{{ component.manufacturer or 'Your Company' }}" required>
                        </div>
                    </div>
                </div>
                
                <!-- Deployment Settings -->
                <div class="form-section">
                    <h5><i class="fas fa-server"></i> Deployment Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Target Server</label>
                            <input type="text" name="target_server" value="{{ component.target_server or '' }}" placeholder="e.g., SERVER01">
                        </div>
                        <div class="form-group">
                            <label>Environment</label>
                            <select name="target_environment">
                                <option value="">Select Environment</option>
                                <option value="DEV" {% if component.target_environment == 'DEV' %}selected{% endif %}>Development</option>
                                <option value="QA" {% if component.target_environment == 'QA' %}selected{% endif %}>QA/Testing</option>
                                <option value="UAT" {% if component.target_environment == 'UAT' %}selected{% endif %}>UAT</option>
                                <option value="PROD" {% if component.target_environment == 'PROD' %}selected{% endif %}>Production</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Install Folder</label>
                            <input type="text" name="install_folder" 
                                   value="{{ component.install_folder or 'C:\\Program Files\\' + (component.app_name or component.component_name) }}">
                        </div>
                    </div>
                </div>
                
                <!-- Component-Specific Settings -->
                {% if component.component_type|lower in ['webapp', 'api'] %}
                <div class="form-section">
                    <h5><i class="fas fa-globe"></i> IIS Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Website Name</label>
                            <input type="text" name="iis_website_name" value="{{ component.iis_website_name or 'Default Web Site' }}">
                        </div>
                        <div class="form-group">
                            <label>App Pool Name</label>
                            <input type="text" name="iis_app_pool_name" 
                                   value="{{ component.iis_app_pool_name or component.component_name + 'AppPool' }}">
                        </div>
                        <div class="form-group">
                            <label>.NET Version</label>
                            <select name="app_pool_dotnet_version">
                                <option value="v4.0">v4.0</option>
                                <option value="v2.0">v2.0</option>
                                <option value="">No Managed Code</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if component.component_type|lower == 'service' %}
                <div class="form-section">
                    <h5><i class="fas fa-cogs"></i> Windows Service Configuration</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Service Name</label>
                            <input type="text" name="service_name" value="{{ component.service_name or component.component_name }}">
                        </div>
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" name="service_display_name" value="{{ component.component_name }}">
                        </div>
                        <div class="form-group">
                            <label>Start Type</label>
                            <select name="service_start_type">
                                <option value="Automatic">Automatic</option>
                                <option value="Manual">Manual</option>
                                <option value="Disabled">Disabled</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <button type="submit" class="save-config-btn">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<script>
// Toggle configuration panel
function toggleConfiguration(componentId) {
    const card = document.querySelector(`[data-component-id="${componentId}"]`);
    const allCards = document.querySelectorAll('.component-card');
    
    // Close all other expanded cards
    allCards.forEach(c => {
        if (c !== card) {
            c.classList.remove('expanded');
        }
    });
    
    // Toggle current card
    card.classList.toggle('expanded');
    
    // Scroll to card if expanded
    if (card.classList.contains('expanded')) {
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

// Filter components by search term
function filterComponents() {
    const searchTerm = document.getElementById('componentSearch').value.toLowerCase();
    const cards = document.querySelectorAll('.component-card');
    
    cards.forEach(card => {
        const name = card.dataset.componentName || '';
        const project = card.dataset.project || '';
        const visible = name.includes(searchTerm) || project.includes(searchTerm);
        
        card.style.display = visible ? 'block' : 'none';
    });
}

// Filter by component type
function filterByType(type) {
    const cards = document.querySelectorAll('.component-card');
    const chips = document.querySelectorAll('.filter-chip');
    
    // Update active chip
    chips.forEach(chip => chip.classList.remove('active'));
    event.target.classList.add('active');
    
    cards.forEach(card => {
        if (type === 'all') {
            card.style.display = 'block';
        } else {
            const cardType = card.dataset.componentType;
            card.style.display = cardType === type ? 'block' : 'none';
        }
    });
}

// Filter by status
function filterByStatus(status) {
    const cards = document.querySelectorAll('.component-card');
    const chips = document.querySelectorAll('.filter-chip');
    
    // Update active chip
    chips.forEach(chip => chip.classList.remove('active'));
    event.target.classList.add('active');
    
    cards.forEach(card => {
        const cardStatus = card.dataset.status;
        card.style.display = cardStatus === status ? 'block' : 'none';
    });
}

// View component details
function viewDetails(componentId) {
    // Could open a modal or navigate to a details page
    console.log('View details for component:', componentId);
}

// Save configuration
function saveConfiguration(event, componentId) {
    event.preventDefault();
    
    const form = document.getElementById(`config-form-${componentId}`);
    const formData = new FormData(form);
    const submitBtn = form.querySelector('.save-config-btn');
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    
    fetch('/save-msi-config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Configuration saved successfully!', 'success');
            updateCardStatus(componentId, 'configured');
        } else {
            showNotification(data.message || 'Error saving configuration', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving configuration', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Configuration';
        submitBtn.disabled = false;
    });
}

// Update card status after saving
function updateCardStatus(componentId, status) {
    const card = document.querySelector(`[data-component-id="${componentId}"]`);
    if (card) {
        card.dataset.status = status;
        const ribbon = card.querySelector('.status-ribbon');
        if (ribbon) {
            ribbon.className = 'status-ribbon ' + status;
            ribbon.textContent = status === 'configured' ? 'Configured' : 'Needs Setup';
        }
    }
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    switch(type) {
        case 'success':
            notification.style.background = '#4682b4';
            break;
        case 'error':
            notification.style.background = '#dc3545';
            break;
        default:
            notification.style.background = '#87ceeb';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Add keyboard shortcut for search
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            document.getElementById('componentSearch').focus();
        }
    });
});
</script>
{% endblock %}