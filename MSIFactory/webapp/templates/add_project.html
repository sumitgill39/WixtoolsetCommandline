{% extends "base_sidebar.html" %}

{% block title %}Add New Project - CelerDeploy{% endblock %}
{% block page_title %}Add New Project{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Project</h5>
                    <a href="{{ url_for('project_management') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Projects
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_project') }}" id="addProjectForm">
                    <!-- Project Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="project_name" class="form-label">Project Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project_name" name="project_name" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="project_key" class="form-label">Project Short Key <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project_key" name="project_key" required pattern="[A-Z0-9]{2,10}" title="2-10 uppercase letters and numbers only" style="text-transform: uppercase;">
                            <div class="form-text">2-10 uppercase letters and numbers only</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="project_guid" class="form-label">Project UUID/GUID <span class="text-muted">(Auto-generated)</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-light" id="project_guid" name="project_guid" readonly>
                                <button type="button" class="btn btn-outline-secondary" onclick="generateNewGuid()">
                                    <i class="fas fa-sync-alt"></i> Regenerate
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe the project purpose and scope..."></textarea>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="project_type" class="form-label">Project Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="project_type" name="project_type" required>
                                <option value="">Select Project Type</option>
                                <option value="WebApp">Web Application</option>
                                <option value="Service">Windows Service</option>
                                <option value="Website">Standalone Website</option>
                                <option value="Desktop">Desktop Application</option>
                                <option value="API">API Service</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="owner_team" class="form-label">Owner Team <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="owner_team" name="owner_team" required placeholder="e.g., Development Team, DevOps Team">
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{{ url_for('project_management') }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Create Project
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
let componentCounter = 0;

function generateGuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function generateNewGuid() {
    document.getElementById('project_guid').value = generateGuid();
}

function generateProjectComponentGuid(projectKey, componentCounter) {
    // Generate component GUID in format: PROJECTKEY-XXXX-YYYY-ZZZZ
    const cleanProjectKey = (projectKey || 'PROJ').toUpperCase().substring(0, 8).padEnd(8, '0');
    const section1 = Math.floor(Math.random() * 65536).toString(16).padStart(4, '0').toUpperCase();
    const section2 = Math.floor(Math.random() * 65536).toString(16).padStart(4, '0').toUpperCase();
    const section3 = componentCounter.toString(16).padStart(4, '0').toUpperCase();

    return `${cleanProjectKey}-${section1}-${section2}-${section3}`;
}

// Component Management Functions
function addNewComponent() {
    // Validate that project short key is provided
    const projectKeyInput = document.getElementById('project_key');
    const projectKey = projectKeyInput.value.trim();

    if (!projectKey) {
        alert('Please enter a Project Short Key before adding components. The short key is required to generate unique component identifiers.');
        projectKeyInput.focus();
        projectKeyInput.classList.add('is-invalid');
        return;
    }

    // Remove invalid class if it was added previously
    projectKeyInput.classList.remove('is-invalid');

    componentCounter++;

    // Generate project-specific component GUID
    const componentGuid = generateProjectComponentGuid(projectKey, componentCounter);

    const componentHtml = `
        <div class="card border-light mb-3 component-card" data-component-id="new_${componentCounter}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                    <strong>New Component ${componentCounter}</strong>
                    <span class="badge bg-success ms-2">NEW</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeComponent('new_${componentCounter}')">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
            <div class="card-body">
                <input type="hidden" name="component_guid_${componentCounter}" value="${componentGuid}">

                <!-- Component GUID Display -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Component GUID</label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-light" value="${componentGuid}" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="regenerateComponentGuid(this, '${projectKey}', ${componentCounter})">
                                <i class="fas fa-sync-alt"></i> Regenerate
                            </button>
                        </div>
                        <small class="text-muted">Format: ${projectKey}-XXXX-YYYY-${componentCounter.toString(16).padStart(4, '0').toUpperCase()}</small>
                    </div>
                </div>

                <!-- Basic Component Information -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Component Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="component_name_${componentCounter}" placeholder="e.g., WebPortal" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Component Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="component_type_${componentCounter}" onchange="toggleComponentFields(this, 'new_${componentCounter}')" required>
                            <option value="">Select Type</option>
                            <option value="webapp">Web App</option>
                            <option value="website">Website</option>
                            <option value="service">Windows Service</option>
                            <option value="api">API</option>
                            <option value="scheduler">Scheduler</option>
                            <option value="desktop">Desktop App</option>
                            <option value="library">Library/DLL</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Framework <span class="text-danger">*</span></label>
                        <select class="form-select" name="component_framework_${componentCounter}" required>
                            <option value="">Select Framework</option>
                            <option value="netframework">.NET Framework</option>
                            <option value="netcore">.NET Core/.NET 5+</option>
                            <option value="react">React</option>
                            <option value="angular">Angular</option>
                            <option value="vue">Vue.js</option>
                            <option value="python">Python</option>
                            <option value="nodejs">Node.js</option>
                            <option value="static">Static HTML</option>
                        </select>
                    </div>
                </div>

                <!-- MSI Package Information -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Application Name</label>
                        <input type="text" class="form-control" name="component_app_name_${componentCounter}" placeholder="e.g., My Application">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Version</label>
                        <input type="text" class="form-control" name="component_version_${componentCounter}" value="1.0.0.0" placeholder="1.0.0.0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-control" name="component_manufacturer_${componentCounter}" placeholder="Your Company">
                    </div>
                </div>

                <!-- Deployment Configuration -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Target Server</label>
                        <input type="text" class="form-control" name="component_target_server_${componentCounter}" placeholder="e.g., PRODWEB01">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Install Folder</label>
                        <input type="text" class="form-control" name="component_install_folder_${componentCounter}" placeholder="e.g., C:\\inetpub\\wwwroot\\MyApp">
                    </div>
                </div>

                <!-- IIS Configuration (for Web Apps) -->
                <div class="row mb-3 iis-config-new_${componentCounter}" style="display: none;">
                    <div class="col-12">
                        <h6 class="text-primary mb-2"><i class="fas fa-globe me-1"></i>IIS Configuration</h6>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Website Name</label>
                        <input type="text" class="form-control" name="component_iis_website_${componentCounter}" placeholder="Default Web Site">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Application Pool</label>
                        <input type="text" class="form-control" name="component_app_pool_${componentCounter}" placeholder="DefaultAppPool">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" name="component_port_${componentCounter}" placeholder="80">
                    </div>
                </div>

                <!-- Windows Service Configuration -->
                <div class="row mb-3 service-config-new_${componentCounter}" style="display: none;">
                    <div class="col-12">
                        <h6 class="text-primary mb-2"><i class="fas fa-cog me-1"></i>Service Configuration</h6>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Service Name</label>
                        <input type="text" class="form-control" name="component_service_name_${componentCounter}" placeholder="MyService">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Service Display Name</label>
                        <input type="text" class="form-control" name="component_service_display_${componentCounter}" placeholder="My Application Service">
                    </div>
                </div>

                <!-- Artifact Configuration -->
                <div class="row">
                    <div class="col-12">
                        <label class="form-label">Artifact Source URL</label>
                        <input type="text" class="form-control" name="component_artifact_${componentCounter}" placeholder="https://artifactory.company.com/repo/component">
                    </div>
                </div>
            </div>
        </div>
    `;

    const container = document.getElementById('componentsContainer');
    const noMessage = document.getElementById('noComponentsMessage');
    if (noMessage) {
        noMessage.style.display = 'none';
    }

    container.insertAdjacentHTML('beforeend', componentHtml);
}

function removeComponent(componentId) {
    const componentCard = document.querySelector(`[data-component-id="${componentId}"]`);
    if (componentCard) {
        componentCard.remove();
        checkEmptyComponents();
    }
}

function checkEmptyComponents() {
    const components = document.querySelectorAll('.component-card');
    const container = document.getElementById('componentsContainer');

    if (components.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted" id="noComponentsMessage">
                <i class="fas fa-cubes fa-2x mb-2"></i>
                <p>No components added yet. Click "Add Component" to define project components.</p>
            </div>
        `;
    }
}

function toggleComponentFields(selectElement, componentId) {
    const componentType = selectElement.value;
    const componentCard = selectElement.closest('.component-card');

    // Hide all conditional sections first
    const iisConfig = componentCard.querySelector('.iis-config-' + componentId);
    const serviceConfig = componentCard.querySelector('.service-config-' + componentId);

    if (iisConfig) iisConfig.style.display = 'none';
    if (serviceConfig) serviceConfig.style.display = 'none';

    // Show relevant sections based on type
    if (componentType === 'webapp' || componentType === 'website' || componentType === 'api') {
        if (iisConfig) iisConfig.style.display = 'flex';
    } else if (componentType === 'service' || componentType === 'scheduler') {
        if (serviceConfig) serviceConfig.style.display = 'flex';
    }
}

function regenerateComponentGuid(button, projectKey, componentCounter) {
    // Generate new GUID
    const newGuid = generateProjectComponentGuid(projectKey, componentCounter);

    // Find the input group and update the display
    const inputGroup = button.closest('.input-group');
    const guidInput = inputGroup.querySelector('input[type="text"]');
    const hiddenInput = button.closest('.card-body').querySelector('input[type="hidden"]');

    // Update both visible and hidden inputs
    guidInput.value = newGuid;
    hiddenInput.value = newGuid;

    // Show brief feedback
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check text-success"></i> Updated';
    button.disabled = true;

    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1500);
}


document.addEventListener('DOMContentLoaded', function() {
    // Generate initial GUID
    generateNewGuid();
    
    // Auto-generate project key from project name
    document.getElementById('project_name').addEventListener('input', function() {
        const projectName = this.value.toUpperCase();
        const projectKey = projectName.replace(/[^A-Z0-9]/g, '').substring(0, 10);
        document.getElementById('project_key').value = projectKey;
    });
    
    // Convert project key to uppercase and remove invalid state
    document.getElementById('project_key').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
        // Remove invalid state when user starts typing
        if (this.value.trim()) {
            this.classList.remove('is-invalid');
        }
    });
    
});

// Simple UI helper functions only - no business logic
function generateNewGuid() {
    // Generate a new GUID for the project
    const guid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
    document.getElementById('project_guid').value = guid;
}
</script>
{% endblock %}