{% extends "base_sidebar.html" %}

{% block title %}Add Component - CelerDeploy{% endblock %}
{% block page_title %}Add Component{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Component</h5>
                    <a href="{{ url_for('component_configuration') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Components
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_component') }}">
                    <!-- Basic Information -->
                    <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="project_id" class="form-label">Project <span class="text-danger">*</span></label>
                            <select name="project_id" id="project_id" class="form-select" required>
                                <option value="">Select Project</option>
                                {% for project in projects %}
                                <option value="{{ project.project_id }}">{{ project.project_name }} ({{ project.project_key }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="component_name" class="form-label">Component Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="component_name" name="component_name" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="component_type" class="form-label">Component Type <span class="text-danger">*</span></label>
                            <select name="component_type" id="component_type" class="form-select" required>
                                <option value="">Select Type</option>
                                <option value="webapp">Web App</option>
                                <option value="website">Website</option>
                                <option value="service">Windows Service</option>
                                <option value="api">API Service</option>
                                <option value="scheduler">Scheduler</option>
                                <option value="desktop">Desktop App</option>
                                <option value="library">Library/DLL</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="framework" class="form-label">Framework <span class="text-danger">*</span></label>
                            <select name="framework" id="framework" class="form-select" required>
                                <option value="">Select Framework</option>
                                <option value="netframework">.NET Framework</option>
                                <option value="netcore">.NET Core/.NET 5+</option>
                                <option value="python">Python</option>
                                <option value="nodejs">Node.js</option>
                                <option value="react">React</option>
                                <option value="angular">Angular</option>
                                <option value="vue">Vue.js</option>
                                <option value="static">Static HTML</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="component_guid" class="form-label">Component GUID <span class="text-muted">(System Generated)</span></label>
                            <input type="text" class="form-control bg-light" id="component_guid" name="component_guid"
                                   placeholder="Select project to generate: PROJECT_KEY-XXXX-XXXX-XXXX" readonly>
                            <div class="form-text">GUID is automatically generated using project key + unique identifiers</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Component Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_enabled" name="is_enabled" value="1">
                                <label class="form-check-label" for="is_enabled">
                                    Enable Component
                                </label>
                                <div class="form-text">By default, components are disabled until ready for deployment</div>
                            </div>
                        </div>
                    </div>

                    <!-- MSI Package Information -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4">MSI Package Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="app_name" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="app_name" name="app_name">
                        </div>
                        <div class="col-md-4">
                            <label for="app_version" class="form-label">Version</label>
                            <input type="text" class="form-control" id="app_version" name="app_version"
                                   value="1.0.0.0" placeholder="1.0.0.0">
                        </div>
                        <div class="col-md-4">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="manufacturer" name="manufacturer"
                                   placeholder="Your Company">
                        </div>
                    </div>

                    <!-- Deployment Configuration -->
                    <h6 class="border-bottom pb-2 mb-3 mt-4">Deployment Configuration</h6>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="install_folder" class="form-label">Install Folder</label>
                            <input type="text" class="form-control" id="install_folder" name="install_folder"
                                   placeholder="C:\Program Files\AppName">
                        </div>
                    </div>

                    <!-- IIS Configuration (shown for web components) -->
                    <div id="iis_section">
                        <h6 class="border-bottom pb-2 mb-3 mt-4">IIS Configuration</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="iis_website_name" class="form-label">Website Name</label>
                                <input type="text" class="form-control" id="iis_website_name" name="iis_website_name"
                                       placeholder="Default Web Site">
                            </div>
                            <div class="col-md-4">
                                <label for="iis_app_pool_name" class="form-label">Application Pool</label>
                                <input type="text" class="form-control" id="iis_app_pool_name" name="iis_app_pool_name"
                                       placeholder="AppPool">
                            </div>
                            <div class="col-md-4">
                                <label for="port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="port" name="port"
                                       placeholder="80" min="1" max="65535">
                            </div>
                        </div>
                    </div>

                    <!-- Windows Service Configuration (shown for service components) -->
                    <div id="service_section" style="display: none;">
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Windows Service Configuration</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="service_name" class="form-label">Service Name</label>
                                <input type="text" class="form-control" id="service_name" name="service_name"
                                       placeholder="MyWindowsService">
                            </div>
                            <div class="col-md-6">
                                <label for="service_display_name" class="form-label">Service Display Name</label>
                                <input type="text" class="form-control" id="service_display_name" name="service_display_name"
                                       placeholder="My Windows Service">
                            </div>
                        </div>
                    </div>


                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('component_configuration') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Add Component
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide sections based on component type selection
document.addEventListener('DOMContentLoaded', function() {
    const componentType = document.getElementById('component_type');
    const iisSection = document.getElementById('iis_section');
    const serviceSection = document.getElementById('service_section');

    function toggleSections() {
        const type = componentType.value;

        // Show IIS section for web components
        if (type === 'webapp' || type === 'website' || type === 'api') {
            iisSection.style.display = 'block';
            serviceSection.style.display = 'none';
        }
        // Show Service section for Windows services
        else if (type === 'service') {
            iisSection.style.display = 'none';
            serviceSection.style.display = 'block';
        }
        // Hide both for other types
        else {
            iisSection.style.display = 'none';
            serviceSection.style.display = 'none';
        }
    }

    componentType.addEventListener('change', toggleSections);
    toggleSections(); // Initial check

    // GUID field functionality
    const guidField = document.getElementById('component_guid');
    const projectSelect = document.getElementById('project_id');

    // Generate GUID when project is selected
    function generateProjectBasedGUID() {
        const selectedProject = projectSelect.options[projectSelect.selectedIndex];
        if (selectedProject && selectedProject.value) {
            // Extract project key from option text (assumes format: "Project Name (PROJECT_KEY)")
            const optionText = selectedProject.text;
            const projectKeyMatch = optionText.match(/\(([^)]+)\)$/);
            let projectKey = projectKeyMatch ? projectKeyMatch[1] : 'UNKNOWN';

            // Clean and format project key (match backend logic)
            projectKey = projectKey.toUpperCase().substring(0, 8).padEnd(8, '0');

            // Generate project-based GUID: PROJECT_KEY-XXXX-YYYY-ZZZZ (match backend format)
            const section1 = generateRandomHexPart(4);
            const section2 = generateRandomHexPart(4);
            const section3 = generateRandomHexPart(4); // This would be component counter in backend

            const guid = `${projectKey}-${section1}-${section2}-${section3}`;
            return guid.toUpperCase();
        }
        return '';
    }

    // Generate random hex part
    function generateRandomHexPart(length) {
        return Array.from({length}, () => Math.floor(Math.random() * 16).toString(16)).join('').toUpperCase();
    }

    // Update GUID when project selection changes - system generated only
    projectSelect.addEventListener('change', function() {
        if (this.value) {
            guidField.value = generateProjectBasedGUID();
        } else {
            guidField.value = '';
        }
    });

</script>
{% endblock %}