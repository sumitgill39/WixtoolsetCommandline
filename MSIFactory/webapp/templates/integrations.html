{% extends "base_sidebar.html" %}

{% block title %}Integrations - CelerDeploy{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-plug me-2"></i>External System Integrations</h1>
                <div>
                    <form method="POST" action="/integrations/test_all" style="display: inline;">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle me-1"></i>Test All Connections
                        </button>
                    </form>
                </div>
            </div>

            <!-- JFrog Artifactory Integration -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-archive me-2"></i>JFrog Artifactory Integration
                            <span id="jfrogStatus" class="badge bg-secondary ms-2">Not Configured</span>
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>JFrog Central Configuration:</strong> Configure your global JFrog Artifactory credentials here.
                        Path patterns and version strategies are configured per component in the
                        <a href="/component_configuration" class="alert-link">Component Configuration</a> page.
                    </div>

                    <form method="POST" action="/integrations/jfrog/save">
                        <!-- Hidden field to preserve config_id for UPDATE operations -->
                        {% if jfrog_config and jfrog_config.config_id %}
                        <input type="hidden" name="config_id" value="{{ jfrog_config.config_id }}">
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="jfrog_base_url" class="form-label">Artifactory Base URL <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="url" class="form-control" id="jfrog_base_url" name="jfrog_base_url"
                                               placeholder="https://company.jfrog.io/artifactory" required
                                               value="{{ jfrog_config.base_url if jfrog_config else '' }}"
                                               {% if jfrog_config and jfrog_config.base_url and not jfrog_url_edit_mode %}readonly{% endif %}>
                                        {% if jfrog_config and jfrog_config.base_url and not jfrog_url_edit_mode %}
                                        <form method="POST" action="/integrations/jfrog/edit_url" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-secondary">
                                                <i class="fas fa-edit me-1"></i>Edit URL
                                            </button>
                                        </form>
                                        {% elif jfrog_url_edit_mode %}
                                        <form method="POST" action="/integrations/jfrog/lock_url" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-warning">
                                                <i class="fas fa-lock me-1"></i>Lock URL
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    <div class="form-text">
                                        Your JFrog Artifactory base URL (without repository path)
                                        {% if jfrog_config and jfrog_config.base_url and not jfrog_url_edit_mode %}
                                        <br><small class="text-warning"><i class="fas fa-lock me-1"></i>URL is locked to prevent multiple entries. Click "Edit URL" to modify.</small>
                                        {% elif jfrog_url_edit_mode %}
                                        <br><small class="text-info"><i class="fas fa-unlock me-1"></i>URL is unlocked for editing. Click "Lock URL" when finished.</small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="jfrog_username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="jfrog_username" name="jfrog_username" required
                                               value="{{ jfrog_config.username if jfrog_config else '' }}"
                                               {% if jfrog_config and jfrog_config.username and not jfrog_url_edit_mode %}readonly{% endif %}>
                                        {% if jfrog_config and jfrog_config.username and not jfrog_url_edit_mode %}
                                        <form method="POST" action="/integrations/jfrog/edit_url" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-secondary">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    <div class="form-text">
                                        JFrog Artifactory username
                                        {% if jfrog_config and jfrog_config.username and not jfrog_url_edit_mode %}
                                        <br><small class="text-warning"><i class="fas fa-lock me-1"></i>Username is locked. Click "Edit" to modify.</small>
                                        {% elif jfrog_url_edit_mode %}
                                        <br><small class="text-info"><i class="fas fa-unlock me-1"></i>Username is unlocked for editing.</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="jfrog_password" class="form-label">Password/API Token <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="jfrog_password" name="jfrog_password" required
                                               {% if jfrog_config and jfrog_config.has_password and not jfrog_password_edit_mode %}value="********" readonly{% endif %}>
                                        {% if jfrog_config and jfrog_config.has_password and not jfrog_password_edit_mode %}
                                        <form method="POST" action="/integrations/jfrog/edit_password" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-secondary">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                        </form>
                                        {% elif jfrog_password_edit_mode %}
                                        <form method="POST" action="/integrations/jfrog/lock_password" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-warning">
                                                <i class="fas fa-lock me-1"></i>Lock Password
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    <div class="form-text">
                                        JFrog password or API token
                                        {% if jfrog_config and jfrog_config.has_password and not jfrog_password_edit_mode %}
                                        <br><small class="text-warning"><i class="fas fa-lock me-1"></i>Password is locked (displayed as ********). Click "Edit" to modify.</small>
                                        {% elif jfrog_password_edit_mode %}
                                        <br><small class="text-info"><i class="fas fa-unlock me-1"></i>Password is unlocked for editing. Click "Lock Password" when finished.</small>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="jfrog_curl_path" class="form-label">Curl.exe Path</label>
                                    <input type="text" class="form-control" id="jfrog_curl_path" name="jfrog_curl_path"
                                           placeholder="Leave empty for auto-detection"
                                           value="{{ jfrog_config.curl_path if jfrog_config else '' }}">
                                    <div class="form-text">Path to curl.exe for artifact downloads (auto-detected if not specified)</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Configuration
                                </button>
                                <a href="/integrations" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ServiceNow Integration -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud me-2"></i>ServiceNow CMDB Integration
                            <span id="snowStatus" class="badge bg-secondary ms-2">Not Configured</span>
                        </h5>
                        <div>
                            <form method="POST" action="/integrations/servicenow/test" style="display: inline;">
                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-check me-1"></i>Test Connection
                                </button>
                            </form>
                            <form method="POST" action="/integrations/servicenow/sync" style="display: inline;">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-sync me-1"></i>Sync Servers
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="/integrations/servicenow/save">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="snow_instance_url" class="form-label">Instance URL *</label>
                                    <input type="url" class="form-control" id="snow_instance_url" name="snow_instance_url"
                                           placeholder="https://yourcompany.service-now.com" required>
                                    <div class="form-text">Your ServiceNow instance URL</div>
                                </div>

                                <div class="mb-3">
                                    <label for="snow_username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="snow_username" name="snow_username" required>
                                    <div class="form-text">ServiceNow API username</div>
                                </div>

                                <div class="mb-3">
                                    <label for="snow_password" class="form-label">Password *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="snow_password" name="snow_password" required>
                                        <span class="input-group-text">
                                            <i class="fas fa-eye"></i>
                                        </span>
                                    </div>
                                    <div class="form-text">ServiceNow API password (stored securely in Vault)</div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="snow_auto_sync" name="snow_auto_sync">
                                        <label class="form-check-label" for="snow_auto_sync">
                                            Enable automatic synchronization (daily)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="snow_table" class="form-label">CMDB Table</label>
                                    <select class="form-select" id="snow_table" name="snow_table">
                                        <option value="cmdb_ci_server" selected>Servers (cmdb_ci_server)</option>
                                        <option value="cmdb_ci_computer">Computers (cmdb_ci_computer)</option>
                                        <option value="cmdb_ci_linux_server">Linux Servers (cmdb_ci_linux_server)</option>
                                        <option value="cmdb_ci_win_server">Windows Servers (cmdb_ci_win_server)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="snow_filter" class="form-label">Additional Filters</label>
                                    <textarea class="form-control" id="snow_filter" name="snow_filter" rows="2"
                                              placeholder="operational_status=Operational^environment=Production"></textarea>
                                    <div class="form-text">ServiceNow query filters (optional)</div>
                                </div>

                                <div class="mb-3">
                                    <label for="snow_sync_frequency" class="form-label">Sync Frequency</label>
                                    <select class="form-select" id="snow_sync_frequency" name="snow_sync_frequency">
                                        <option value="manual">Manual Only</option>
                                        <option value="hourly">Every Hour</option>
                                        <option value="daily" selected>Daily</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Last Sync Status</label>
                                    <div id="snowLastSync" class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>No sync performed yet
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Configuration
                                </button>
                                <a href="/integrations/servicenow/clear" class="btn btn-outline-danger ms-2">
                                    <i class="fas fa-trash me-1"></i>Clear Configuration
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- HashiCorp Vault Integration -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-vault me-2"></i>HashiCorp Vault Integration
                            <span id="vaultStatus" class="badge bg-secondary ms-2">Not Configured</span>
                        </h5>
                        <div>
                            <form method="POST" action="/integrations/vault/test" style="display: inline;">
                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-check me-1"></i>Test Connection
                                </button>
                            </form>
                            <form method="GET" action="/integrations/vault/secrets" style="display: inline;">
                                <button type="submit" class="btn btn-info btn-sm">
                                    <i class="fas fa-key me-1"></i>View Secrets
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="/integrations/vault/save">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vault_url" class="form-label">Vault URL *</label>
                                    <input type="url" class="form-control" id="vault_url" name="vault_url"
                                           placeholder="https://vault.company.com:8200" required>
                                    <div class="form-text">HashiCorp Vault server URL</div>
                                </div>

                                <div class="mb-3">
                                    <label for="vault_auth_method" class="form-label">Authentication Method</label>
                                    <select class="form-select" id="vault_auth_method" name="vault_auth_method">
                                        <option value="token" selected>Token</option>
                                        <option value="userpass">Username/Password</option>
                                        <option value="ldap">LDAP</option>
                                        <option value="approle">AppRole</option>
                                    </select>
                                </div>

                                <!-- Token Auth -->
                                <div id="vaultTokenAuth" class="mb-3">
                                    <label for="vault_token" class="form-label">Vault Token *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="vault_token" name="vault_token">
                                        <span class="input-group-text">
                                            <i class="fas fa-eye"></i>
                                        </span>
                                    </div>
                                    <div class="form-text">Vault authentication token</div>
                                </div>

                                <!-- Username/Password Auth -->
                                <div id="vaultUserPassAuth" style="display: none;">
                                    <div class="mb-3">
                                        <label for="vault_username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="vault_username" name="vault_username">
                                    </div>
                                    <div class="mb-3">
                                        <label for="vault_user_password" class="form-label">Password</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="vault_user_password" name="vault_user_password">
                                            <span class="input-group-text">
                                                <i class="fas fa-eye"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- AppRole Auth -->
                                <div id="vaultAppRoleAuth" style="display: none;">
                                    <div class="mb-3">
                                        <label for="vault_role_id" class="form-label">Role ID</label>
                                        <input type="text" class="form-control" id="vault_role_id" name="vault_role_id">
                                    </div>
                                    <div class="mb-3">
                                        <label for="vault_secret_id" class="form-label">Secret ID</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="vault_secret_id" name="vault_secret_id">
                                            <span class="input-group-text">
                                                <i class="fas fa-eye"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vault_mount_path" class="form-label">Secrets Engine Mount Path</label>
                                    <input type="text" class="form-control" id="vault_mount_path" name="vault_mount_path"
                                           value="secret" placeholder="secret">
                                    <div class="form-text">KV secrets engine mount path</div>
                                </div>

                                <div class="mb-3">
                                    <label for="vault_app_path" class="form-label">Application Secret Path</label>
                                    <input type="text" class="form-control" id="vault_app_path" name="vault_app_path"
                                           value="msifactory" placeholder="msifactory">
                                    <div class="form-text">Path where CelerDeploy secrets are stored</div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="vault_ssl_verify" name="vault_ssl_verify" checked>
                                        <label class="form-check-label" for="vault_ssl_verify">
                                            Verify SSL certificates
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="vault_auto_renew" name="vault_auto_renew" checked>
                                        <label class="form-check-label" for="vault_auto_renew">
                                            Enable automatic token renewal
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Connection Status</label>
                                    <div id="vaultLastCheck" class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>No connection test performed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Configuration
                                </button>
                                <a href="/integrations/vault/clear" class="btn btn-outline-danger ms-2">
                                    <i class="fas fa-trash me-1"></i>Clear Configuration
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>


        </div>
    </div>
</div>

<!-- Modals -->
<!-- Vault Secrets Modal -->
<div class="modal fade" id="vaultSecretsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key me-2"></i>Vault Secrets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="vaultSecretsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Results Modal -->
<div class="modal fade" id="syncResultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-sync me-2"></i>Synchronization Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="syncResultsContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}