{% extends "base_sidebar.html" %}

{% block title %}Edit Project - MSI Factory{% endblock %}
{% block page_title %}Edit Project{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Project</h5>
                    <a href="{{ url_for('project_management') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Projects
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('edit_project') }}" id="editProjectForm">
                    <input type="hidden" name="project_id" value="{{ project.project_id }}">

                    <!-- Project Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="project_name" class="form-label">Project Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project_name" name="project_name" value="{{ project.project_name }}" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="project_key" class="form-label">Project Short Key <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project_key" name="project_key" value="{{ project.project_key }}" required pattern="[A-Z0-9]{2,10}" title="2-10 uppercase letters and numbers only" style="text-transform: uppercase;">
                        </div>

                        <div class="col-12 mb-3">
                            <label for="project_guid" class="form-label">Project UUID/GUID <span class="text-muted">(From Database)</span></label>
                            <input type="text" class="form-control bg-light" id="project_guid" name="project_guid" value="{{ project.project_guid or '' }}" readonly title="Project GUID is managed by the system and cannot be modified">
                            {% if project.project_guid %}
                            <small class="text-muted">Project GUID is locked to prevent breaking references and ensure data integrity.</small>
                            {% else %}
                            <small class="text-muted">No GUID assigned. GUIDs are only generated during project creation.</small>
                            {% endif %}
                        </div>

                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe the project purpose and scope...">{{ project.description or '' }}</textarea>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="project_type" class="form-label">Project Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="project_type" name="project_type" required>
                                <option value="">Select Project Type</option>
                                <option value="WebApp" {% if project.project_type == 'WebApp' %}selected{% endif %}>Web Application</option>
                                <option value="Service" {% if project.project_type == 'Service' %}selected{% endif %}>Windows Service</option>
                                <option value="Website" {% if project.project_type == 'Website' %}selected{% endif %}>Standalone Website</option>
                                <option value="Desktop" {% if project.project_type == 'Desktop' %}selected{% endif %}>Desktop Application</option>
                                <option value="API" {% if project.project_type == 'API' %}selected{% endif %}>API Service</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="owner_team" class="form-label">Owner Team <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="owner_team" name="owner_team" value="{{ project.owner_team }}" required placeholder="e.g., Development Team, DevOps Team">
                        </div>
                    </div>

                    <!-- Components Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-cubes me-2"></i>Components
                                <button type="button" class="btn btn-sm btn-success ms-2" onclick="addNewComponent()">
                                    <i class="fas fa-plus"></i> Add Component
                                </button>
                            </h6>
                        </div>

                        <div class="col-12">
                            <div id="componentsContainer">
                                {% if components %}
                                    {% for component in components %}
                                    <div class="card border-light mb-3 component-card {% if component.is_enabled == False %}component-disabled{% endif %}" data-component-id="{{ component.component_id }}" data-enabled="{{ component.is_enabled }}">
                                        <!-- Component Header (Always Visible) -->
                                        <div class="component-header" onclick="toggleComponent({{ component.component_id }})">
                                            <div class="component-main-info">
                                                <div class="component-icon" style="background: linear-gradient(135deg, {% if component.is_enabled == False %}#6c757d, #5a6268{% else %}#007bff, #0056b3{% endif %});">
                                                    {% if component.component_type == 'webapp' %}
                                                    <i class="fas fa-globe"></i>
                                                    {% elif component.component_type == 'service' %}
                                                    <i class="fas fa-cogs"></i>
                                                    {% elif component.component_type == 'api' %}
                                                    <i class="fas fa-plug"></i>
                                                    {% elif component.component_type == 'website' %}
                                                    <i class="fas fa-window-restore"></i>
                                                    {% elif component.component_type == 'desktop' %}
                                                    <i class="fas fa-desktop"></i>
                                                    {% else %}
                                                    <i class="fas fa-cube"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="component-title-section">
                                                    <h6 class="component-name">
                                                        {{ component.component_name }}
                                                        {% if component.is_enabled == False %}
                                                        <span class="badge bg-warning ms-2">Disabled</span>
                                                        {% endif %}
                                                    </h6>
                                                    <div class="component-meta">
                                                        <span class="badge bg-primary">{{ component.component_type|upper }}</span>
                                                        {% if component.framework %}
                                                        <span class="badge bg-secondary">{{ component.framework|upper }}</span>
                                                        {% endif %}
                                                        <span class="text-muted ms-2">ID: {{ component.component_id }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="component-actions d-flex align-items-center gap-2">
                                                <div class="component-expand-icon">
                                                    <i class="fas fa-chevron-down"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Expandable Details Section (Hidden by Default) -->
                                        <div class="component-details-curtain" id="component-details-{{ component.component_id }}">
                                            <div class="component-details-content">
                                            <input type="hidden" name="component_guid_existing_{{ loop.index0 }}" value="{{ component.component_guid }}">
                                            <input type="hidden" name="component_id_{{ loop.index0 }}" value="{{ component.component_id }}">

                                            <!-- Component Status Toggle -->
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                                        <div>
                                                            <label class="form-label mb-0">Component Status</label>
                                                            <small class="text-muted d-block">Enable or disable this component for deployments</small>
                                                        </div>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" role="switch"
                                                                   id="component_enabled_{{ component.component_id }}"
                                                                   name="component_enabled_existing_{{ loop.index0 }}"
                                                                   {% if component.is_enabled == True %}checked{% endif %}
>
                                                            <label class="form-check-label ms-2" for="component_enabled_{{ component.component_id }}">
                                                                <span class="badge {% if component.is_enabled == True %}bg-success{% else %}bg-secondary{% endif %}" id="status_badge_{{ component.component_id }}">
                                                                    {% if component.is_enabled == True %}Enabled{% else %}Disabled{% endif %}
                                                                </span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Component GUID Display -->
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <label class="form-label">Component GUID</label>
                                                    <input type="text" class="form-control bg-light" name="component_guid_display_{{ loop.index0 }}" value="{{ component.component_guid or 'No GUID in database' }}" readonly>
                                                    {% if component.component_guid %}
                                                    <small class="text-muted">Component GUID from database (cannot be changed for data integrity)</small>
                                                    {% else %}
                                                    <small class="text-warning">⚠️ Component missing GUID - will be generated when project is saved</small>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Basic Component Information -->
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">Component Name <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" name="component_name_existing_{{ loop.index0 }}" value="{{ component.component_name }}" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Component Type <span class="text-danger">*</span></label>
                                                    <select class="form-select" name="component_type_existing_{{ loop.index0 }}" onchange="toggleComponentFields(this, '{{ component.component_id }}')" required>
                                                        <option value="webapp" {% if component.component_type == 'webapp' %}selected{% endif %}>Web App</option>
                                                        <option value="website" {% if component.component_type == 'website' %}selected{% endif %}>Website</option>
                                                        <option value="service" {% if component.component_type == 'service' %}selected{% endif %}>Windows Service</option>
                                                        <option value="api" {% if component.component_type == 'api' %}selected{% endif %}>API</option>
                                                        <option value="scheduler" {% if component.component_type == 'scheduler' %}selected{% endif %}>Scheduler</option>
                                                        <option value="desktop" {% if component.component_type == 'desktop' %}selected{% endif %}>Desktop App</option>
                                                        <option value="library" {% if component.component_type == 'library' %}selected{% endif %}>Library/DLL</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Framework <span class="text-danger">*</span></label>
                                                    <select class="form-select" name="component_framework_existing_{{ loop.index0 }}" required>
                                                        <option value="netframework" {% if component.framework == 'netframework' %}selected{% endif %}>.NET Framework</option>
                                                        <option value="netcore" {% if component.framework == 'netcore' %}selected{% endif %}>.NET Core/.NET 5+</option>
                                                        <option value="react" {% if component.framework == 'react' %}selected{% endif %}>React</option>
                                                        <option value="angular" {% if component.framework == 'angular' %}selected{% endif %}>Angular</option>
                                                        <option value="vue" {% if component.framework == 'vue' %}selected{% endif %}>Vue.js</option>
                                                        <option value="python" {% if component.framework == 'python' %}selected{% endif %}>Python</option>
                                                        <option value="nodejs" {% if component.framework == 'nodejs' %}selected{% endif %}>Node.js</option>
                                                        <option value="static" {% if component.framework == 'static' %}selected{% endif %}>Static HTML</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Description -->
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <label class="form-label">Description</label>
                                                    <input type="text" class="form-control" name="component_description_existing_{{ loop.index0 }}" value="{{ component.description or '' }}" placeholder="Brief description of this component">
                                                </div>
                                            </div>

                                            <!-- MSI Package Information -->
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="component_app_name_existing_{{ loop.index0 }}" value="{{ component.app_name or component.component_name }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Version</label>
                                                    <input type="text" class="form-control" name="component_version_existing_{{ loop.index0 }}" value="{{ component.app_version or '1.0.0.0' }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Manufacturer</label>
                                                    <input type="text" class="form-control" name="component_manufacturer_existing_{{ loop.index0 }}" value="{{ component.manufacturer or 'Your Company' }}">
                                                </div>
                                            </div>

                                            <!-- Deployment Configuration -->
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <label class="form-label">Install Folder</label>
                                                    <input type="text" class="form-control" name="component_install_folder_existing_{{ loop.index0 }}" value="{{ component.install_folder or 'C:\\inetpub\\wwwroot\\' + component.component_name }}">
                                                </div>
                                            </div>

                                            <!-- IIS Configuration (for Web Apps) -->
                                            <div class="row mb-3 iis-config-{{ component.component_id }}" {% if component.component_type not in ['webapp', 'website', 'api'] %}style="display: none;"{% endif %}>
                                                <div class="col-12">
                                                    <h6 class="text-primary mb-2"><i class="fas fa-globe me-1"></i>IIS Configuration</h6>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Website Name</label>
                                                    <input type="text" class="form-control" name="component_iis_website_existing_{{ loop.index0 }}" value="{{ component.iis_website_name or 'Default Web Site' }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Application Pool</label>
                                                    <input type="text" class="form-control" name="component_app_pool_existing_{{ loop.index0 }}" value="{{ component.iis_app_pool_name or component.component_name + 'AppPool' }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Port</label>
                                                    <input type="number" class="form-control" name="component_port_existing_{{ loop.index0 }}" value="{{ component.port or 80 }}">
                                                </div>
                                            </div>

                                            <!-- Windows Service Configuration -->
                                            <div class="row mb-3 service-config-{{ component.component_id }}" {% if component.component_type != 'service' %}style="display: none;"{% endif %}>
                                                <div class="col-12">
                                                    <h6 class="text-primary mb-2"><i class="fas fa-cog me-1"></i>Service Configuration</h6>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Service Name</label>
                                                    <input type="text" class="form-control" name="component_service_name_existing_{{ loop.index0 }}" value="{{ component.service_name or component.component_name }}">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Service Display Name</label>
                                                    <input type="text" class="form-control" name="component_service_display_existing_{{ loop.index0 }}" value="{{ component.service_display_name or component.component_name + ' Service' }}">
                                                </div>
                                            </div>

                                            <!-- Component Action Buttons -->
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-end gap-2">
                                                        <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); updateComponent('{{ component.component_id }}')">
                                                            <i class="fas fa-save me-1"></i>Update Component
                                                        </button>
                                                        <button type="button" class="btn btn-danger" onclick="event.stopPropagation(); removeComponent('{{ component.component_id }}')">
                                                            <i class="fas fa-trash me-1"></i>Delete This Component
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <div class="text-center py-4 text-muted" id="noComponentsMessage">
                                    <i class="fas fa-cubes fa-2x mb-2"></i>
                                    <p>No components added yet. Click "Add Component" to define project components.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Project Styling -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-palette me-2"></i>Project Styling</h6>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="color_primary" class="form-label">Primary Color</label>
                            <input type="color" class="form-control form-control-color" id="color_primary" name="color_primary" value="{{ project.color_primary }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="color_secondary" class="form-label">Secondary Color</label>
                            <input type="color" class="form-control form-control-color" id="color_secondary" name="color_secondary" value="{{ project.color_secondary }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Project Status</label>
                            <select class="form-select" id="status" name="status" required
                                    hx-get="/htmx/project/status-preview/{{ project.project_id }}"
                                    hx-target="#status-preview"
                                    hx-trigger="change"
                                    hx-vals="js:{status: event.target.value}"
                                    hx-swap="innerHTML">
                                <option value="active" {% if project.status == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if project.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                <option value="maintenance" {% if project.status == 'maintenance' %}selected{% endif %}>Maintenance</option>
                                <option value="archived" {% if project.status == 'archived' %}selected{% endif %}>Archived</option>
                            </select>
                            <div class="form-text">Changes to project status will automatically affect all components in this project.</div>
                        </div>
                    </div>

                    <!-- Project Status Impact Preview -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div id="status-preview" class="mt-2">
                                <!-- Dynamic content loaded via HTMX when status changes -->
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-danger" onclick="deleteProject()">
                                    <i class="fas fa-trash me-1"></i>Delete Project
                                </button>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('project_management') }}" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary" onclick="debugFormSubmission(); return true;">
                                        <i class="fas fa-save me-1"></i>Update Project
                                    </button>
                                    <button type="button" class="btn btn-warning ms-2" onclick="document.getElementById('editProjectForm').submit();">
                                        <i class="fas fa-bug me-1"></i>Force Submit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let componentCounter = {{ components|length if components else 0 }}; // Start from next number after existing components

// GUID generation removed - GUIDs are only generated during project creation
// Edit page only displays the GUID value from the database

function generateProjectComponentGuid(projectKey, componentCounter) {
    // Generate component GUID in format: PROJECTKEY-XXXX-YYYY-ZZZZ
    const cleanProjectKey = (projectKey || 'PROJ').toUpperCase().substring(0, 8).padEnd(8, '0');
    const section1 = Math.floor(Math.random() * 65536).toString(16).padStart(4, '0').toUpperCase();
    const section2 = Math.floor(Math.random() * 65536).toString(16).padStart(4, '0').toUpperCase();
    const section3 = componentCounter.toString(16).padStart(4, '0').toUpperCase();

    return `${cleanProjectKey}-${section1}-${section2}-${section3}`;
}

function addNewComponent() {
    // Validate that project short key is provided
    const projectKeyInput = document.getElementById('project_key');
    const projectKey = projectKeyInput.value.trim();

    if (!projectKey) {
        alert('Please enter a Project Short Key before adding components. The short key is required to generate unique component identifiers.');
        projectKeyInput.focus();
        projectKeyInput.classList.add('is-invalid');
        return;
    }

    // Remove invalid class if it was added previously
    projectKeyInput.classList.remove('is-invalid');

    componentCounter++;

    // Generate project-specific component GUID
    const componentGuid = generateProjectComponentGuid(projectKey, componentCounter);

    const componentHtml = `
        <div class="card border-light mb-3 component-card" data-component-id="new_${componentCounter}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                    <strong>New Component ${componentCounter}</strong>
                    <span class="badge bg-success ms-2">NEW</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeComponent('new_${componentCounter}')">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
            <div class="card-body">
                <input type="hidden" name="new_component_guid_${componentCounter}" value="${componentGuid}">

                <!-- Component Status Toggle -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div>
                                <label class="form-label mb-0">Component Status</label>
                                <small class="text-muted d-block">Enable or disable this component for deployments</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="new_component_enabled_${componentCounter}"
                                       name="new_component_enabled_${componentCounter}"
                                       checked>
                                <label class="form-check-label ms-2" for="new_component_enabled_${componentCounter}">
                                    <span class="badge bg-success">Enabled</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Component GUID Display -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Component GUID <span class="text-muted">(Auto-generated)</span></label>
                        <input type="text" class="form-control bg-light" value="${componentGuid}" readonly title="Component GUID is auto-generated and cannot be modified">
                        <small class="text-muted">Component identifier will be permanently assigned when the project is saved.</small>
                    </div>
                </div>

                <!-- Basic Component Information -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Component Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="new_component_name_${componentCounter}" placeholder="e.g., WebPortal">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Component Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="new_component_type_${componentCounter}" onchange="toggleComponentFields(this, 'new_${componentCounter}')">
                            <option value="">Select Type</option>
                            <option value="webapp">Web App</option>
                            <option value="website">Website</option>
                            <option value="service">Windows Service</option>
                            <option value="api">API</option>
                            <option value="scheduler">Scheduler</option>
                            <option value="desktop">Desktop App</option>
                            <option value="library">Library/DLL</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Framework <span class="text-danger">*</span></label>
                        <select class="form-select" name="new_component_framework_${componentCounter}">
                            <option value="">Select Framework</option>
                            <option value="netframework">.NET Framework</option>
                            <option value="netcore">.NET Core/.NET 5+</option>
                            <option value="react">React</option>
                            <option value="angular">Angular</option>
                            <option value="vue">Vue.js</option>
                            <option value="python">Python</option>
                            <option value="nodejs">Node.js</option>
                            <option value="static">Static HTML</option>
                        </select>
                    </div>
                </div>

                <!-- Description -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="new_component_description_${componentCounter}" placeholder="Brief description of this component">
                    </div>
                </div>

                <!-- MSI Package Information -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Application Name</label>
                        <input type="text" class="form-control" name="new_component_app_name_${componentCounter}" placeholder="e.g., My Application">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Version</label>
                        <input type="text" class="form-control" name="new_component_version_${componentCounter}" value="1.0.0.0" placeholder="1.0.0.0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-control" name="new_component_manufacturer_${componentCounter}" placeholder="Your Company">
                    </div>
                </div>

                <!-- Deployment Configuration -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Install Folder</label>
                        <input type="text" class="form-control" name="new_component_install_folder_${componentCounter}" placeholder="e.g., C:\\inetpub\\wwwroot\\MyApp">
                    </div>
                </div>

                <!-- IIS Configuration (for Web Apps) -->
                <div class="row mb-3 iis-config-new_${componentCounter}" style="display: none;">
                    <div class="col-12">
                        <h6 class="text-primary mb-2"><i class="fas fa-globe me-1"></i>IIS Configuration</h6>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Website Name</label>
                        <input type="text" class="form-control" name="new_component_iis_website_${componentCounter}" placeholder="Default Web Site">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Application Pool</label>
                        <input type="text" class="form-control" name="new_component_app_pool_${componentCounter}" placeholder="DefaultAppPool">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" name="new_component_port_${componentCounter}" placeholder="80">
                    </div>
                </div>

                <!-- Windows Service Configuration -->
                <div class="row mb-3 service-config-new_${componentCounter}" style="display: none;">
                    <div class="col-12">
                        <h6 class="text-primary mb-2"><i class="fas fa-cog me-1"></i>Service Configuration</h6>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Service Name</label>
                        <input type="text" class="form-control" name="new_component_service_name_${componentCounter}" placeholder="MyService">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Service Display Name</label>
                        <input type="text" class="form-control" name="new_component_service_display_${componentCounter}" placeholder="My Application Service">
                    </div>
                </div>

            </div>
        </div>
    `;

    const container = document.getElementById('componentsContainer');
    const noMessage = document.getElementById('noComponentsMessage');
    if (noMessage) {
        noMessage.style.display = 'none';
    }

    container.insertAdjacentHTML('beforeend', componentHtml);
}

function removeComponent(componentId) {
    const componentCard = document.querySelector(`[data-component-id="${componentId}"]`);
    if (componentCard) {
        // If it's an existing component, add hidden input to mark for deletion
        if (!componentId.startsWith('new_')) {
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'delete_components';
            deleteInput.value = componentId;
            document.getElementById('editProjectForm').appendChild(deleteInput);
        }

        componentCard.remove();
        checkEmptyComponents();
    }
}

function checkEmptyComponents() {
    const components = document.querySelectorAll('.component-card');
    const container = document.getElementById('componentsContainer');

    if (components.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted" id="noComponentsMessage">
                <i class="fas fa-cubes fa-2x mb-2"></i>
                <p>No components added yet. Click "Add Component" to define project components.</p>
            </div>
        `;
    }
}

function toggleComponentFields(selectElement, componentId) {
    const iisConfig = document.querySelector(`.iis-config-${componentId}`);
    const serviceConfig = document.querySelector(`.service-config-${componentId}`);

    if (iisConfig && serviceConfig) {
        // Hide all configuration sections first
        iisConfig.style.display = 'none';
        serviceConfig.style.display = 'none';

        // Show relevant configuration based on type
        if (selectElement.value === 'webapp' || selectElement.value === 'website' || selectElement.value === 'api') {
            iisConfig.style.display = 'block';
        } else if (selectElement.value === 'service') {
            serviceConfig.style.display = 'block';
        }
    }
}

function updateComponent(componentId) {
    if (!confirm('Are you sure you want to update this component? This will save all current field values.')) {
        return;
    }

    // Collect all form data for the specific component
    const formData = new FormData();
    formData.append('component_id', componentId);

    // Find all fields that belong to this component (pattern: component_*_existing_${componentId})
    const fieldSelector = `input[name*="_existing_${componentId}"], select[name*="_existing_${componentId}"], textarea[name*="_existing_${componentId}"]`;
    const fields = document.querySelectorAll(fieldSelector);

    fields.forEach(field => {
        if (field.type === 'checkbox') {
            if (field.checked) {
                formData.append(field.name, field.value);
            }
        } else {
            formData.append(field.name, field.value);
        }
    });

    // Show loading state
    const updateButton = document.querySelector(`[onclick*="updateComponent('${componentId}')"]`);
    const originalText = updateButton.innerHTML;
    updateButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    updateButton.disabled = true;

    fetch('/update-component', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showMessage(data.message, 'success');

            // Optionally refresh the page to show updated data
            // window.location.reload();
        } else {
            showMessage(data.error || 'Failed to update component', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating component:', error);
        showMessage('An error occurred while updating the component', 'error');
    })
    .finally(() => {
        // Restore button state
        updateButton.innerHTML = originalText;
        updateButton.disabled = false;
    });
}

function showMessage(message, type) {
    // Create or update message element
    let messageDiv = document.getElementById('message-display');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'message-display';
        messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 12px 20px; border-radius: 4px; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
        document.body.appendChild(messageDiv);
    }

    // Set message content and styling based on type
    messageDiv.textContent = message;
    if (type === 'success') {
        messageDiv.style.backgroundColor = '#d4edda';
        messageDiv.style.color = '#155724';
        messageDiv.style.border = '1px solid #c3e6cb';
    } else {
        messageDiv.style.backgroundColor = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.border = '1px solid #f5c6cb';
    }

    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

// Component GUID regeneration removed - GUIDs are immutable once created
// New components get auto-generated GUIDs that become permanent when saved
// Existing components always display their database GUIDs

function deleteProject() {
    if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_project") }}';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'project_id';
        input.value = '{{ project.project_id }}';

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

// Component collapse functionality
function toggleComponent(componentId) {
    const componentCard = document.querySelector(`[data-component-id="${componentId}"]`);
    componentCard.classList.toggle('expanded');

    // Smooth scroll to view if expanding
    if (componentCard.classList.contains('expanded')) {
        setTimeout(() => {
            componentCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
}

// Component status updates will be handled by server-side form submission - no client-side business logic

document.addEventListener('DOMContentLoaded', function() {
    // Initialize component type fields for existing components
    const existingSelects = document.querySelectorAll('[name^="component_type_existing_"]');
    existingSelects.forEach(select => {
        const componentId = select.closest('.component-card').getAttribute('data-component-id');
        toggleComponentFields(select, componentId);
    });
});

// Debug function for form submission
function debugFormSubmission() {
    console.log('=== DEBUG: Form Submission ===');
    const form = document.getElementById('editProjectForm');
    const formData = new FormData(form);

    console.log('Form data:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }

    // Specifically check status field
    const statusSelect = document.getElementById('status');
    console.log(`Status dropdown element:`, statusSelect);
    console.log(`Status selected value: "${statusSelect.value}"`);
    console.log(`Status selected index: ${statusSelect.selectedIndex}`);
    console.log(`Status selected option text: "${statusSelect.options[statusSelect.selectedIndex].text}"`);

    // Check if status is in form data
    const statusInFormData = formData.get('status');
    console.log(`Status in FormData: "${statusInFormData}"`);

    if (statusInFormData !== statusSelect.value) {
        console.error('ERROR: Status mismatch between select and FormData!');
    }

    console.log('=== END DEBUG ===');
    return true; // Allow form submission to continue
}
</script>

<style>
/* Component Card Styles */
.component-card {
    background: white;
    border: 1px solid #dee2e6 !important;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.component-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.component-header {
    padding: 1.25rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    transition: background 0.3s ease;
}

.component-header:hover {
    background: linear-gradient(to right, #e9ecef, #f8f9fa);
}

.component-main-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.component-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.component-title-section {
    flex: 1;
}

.component-name {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
}

.component-meta {
    margin-top: 0.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.component-actions {
    margin-left: 1rem;
}

.component-expand-icon {
    color: #6c757d;
    transition: transform 0.3s ease;
    margin-left: 0.5rem;
}

.component-card.expanded .component-expand-icon {
    transform: rotate(180deg);
}

/* Curtain Effect Styles */
.component-details-curtain {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(to bottom, #f8f9fa, #ffffff);
}

.component-card.expanded .component-details-curtain {
    max-height: 2000px;
}

.component-details-content {
    padding: 0 1.25rem 1.25rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Disabled Component Styles */
.component-card.component-disabled {
    opacity: 0.7 !important;
    border: 1px solid #dee2e6 !important;
    background: #f8f9fa !important;
    filter: grayscale(20%);
}

.component-card.component-disabled .component-header {
    background: linear-gradient(to right, #e9ecef, #f8f9fa) !important;
}

.component-card.component-disabled .component-name {
    color: #6c757d !important;
}

.component-card.component-disabled .component-meta .badge {
    opacity: 0.8 !important;
}

.component-card.component-disabled:hover {
    transform: none !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
}

/* Debug helper - remove after testing */
.component-disabled {
    border: 3px solid red !important;
}

/* Responsive Design */
@media (max-width: 768px) {
    .component-meta {
        flex-wrap: wrap;
    }

    .component-actions {
        margin-left: 0.5rem;
    }
}
</style>
{% endblock %}