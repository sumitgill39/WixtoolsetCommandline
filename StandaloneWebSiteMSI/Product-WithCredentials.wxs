<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:iis="http://wixtoolset.org/schemas/v4/wxs/iis">

  <!-- Variables for the standalone website -->
  <?define SiteName = "MyWebSite" ?>
  <?define AppName = "MyWebApp" ?>
  <?define AppVersion = "1.0.0.0" ?>
  <?define CompanyName = "My Company" ?>
  <?define AppUpgradeCode = "87654321-4321-4321-4321-210987654321" ?>
  <?define SitePort = "8080" ?>
  <?define SiteIP = "*" ?>
  <?define SitePath = "C:\Websites\$(var.SiteName)" ?>
  
  <!-- CREDENTIAL OPTIONS - Choose one approach -->
  
  <!-- Option 1: ApplicationPoolIdentity (Most Secure - Default) -->
  <?define AppPoolIdentity = "applicationPoolIdentity" ?>
  
  <!-- Option 2: Built-in Account -->
  <!-- <?define AppPoolIdentity = "networkService" ?> -->
  <!-- <?define AppPoolIdentity = "localService" ?> -->
  <!-- <?define AppPoolIdentity = "localSystem" ?> -->
  
  <!-- Option 3: Custom User (requires credentials at install time) -->
  <!-- <?define AppPoolIdentity = "other" ?> -->
  <!-- These would be passed as MSI properties during installation:
       msiexec /i StandaloneWebSite.msi APPPOOL_USER="domain\username" APPPOOL_PASSWORD="password"
  -->

  <!-- WiX v6 Package element -->
  <Package 
    Name="$(var.SiteName) Website"
    Version="$(var.AppVersion)"
    Manufacturer="$(var.CompanyName)"
    UpgradeCode="$(var.AppUpgradeCode)"
    Compressed="true"
    Scope="perMachine">

    <!-- Major upgrade handling -->
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

    <!-- Installation location and credential properties -->
    <Property Id="INSTALLFOLDER" Value="$(var.SitePath)" />
    <Property Id="WEBSITE_PORT" Value="$(var.SitePort)" />
    <Property Id="WEBSITE_IP" Value="$(var.SiteIP)" />
    
    <!-- Credential Properties (for custom user scenario) -->
    <Property Id="APPPOOL_USER" Secure="yes" />
    <Property Id="APPPOOL_PASSWORD" Secure="yes" Hidden="yes" />
    <Property Id="APPPOOL_DOMAIN" Secure="yes" />

    <!-- IIS Application Pool with Credential Configuration -->
    <Component Id="CreateAppPool" Directory="INSTALLFOLDER" Guid="AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAAAA">
      
      <!-- Approach 1: Using built-in identity (applicationPoolIdentity, networkService, etc.) -->
      <?if $(var.AppPoolIdentity) != "other" ?>
        <iis:WebAppPool Id="WebSiteAppPool"
                        Name="$(var.SiteName)AppPool"
                        ManagedRuntimeVersion="v4.0"
                        ManagedPipelineMode="Integrated"
                        Identity="$(var.AppPoolIdentity)"
                        IdleTimeout="20"
                        RecycleMinutes="1740"
                        RecycleRequests="0" />
      <?endif?>
      
      <!-- Approach 2: Using custom user credentials -->
      <?if $(var.AppPoolIdentity) = "other" ?>
        <iis:WebAppPool Id="WebSiteAppPool"
                        Name="$(var.SiteName)AppPool"
                        ManagedRuntimeVersion="v4.0"
                        ManagedPipelineMode="Integrated"
                        Identity="other"
                        User="[APPPOOL_USER]"
                        IdleTimeout="20"
                        RecycleMinutes="1740"
                        RecycleRequests="0" />
      <?endif?>
    </Component>

    <!-- IIS Website Configuration -->
    <Component Id="CreateWebSite" Directory="INSTALLFOLDER" Guid="BBBBBBBB-BBBB-BBBB-BBBB-BBBBBBBBBBBB">
      <iis:WebSite Id="MainWebSite"
                   Description="$(var.SiteName)"
                   Directory="INSTALLFOLDER"
                   AutoStart="yes"
                   ConfigureIfExists="yes">
        <iis:WebAddress Id="HttpBinding" 
                        Port="$(var.SitePort)" 
                        IP="$(var.SiteIP)" />
        <iis:WebApplication Id="MainWebApplication"
                            Name="$(var.AppName)"
                            WebAppPool="WebSiteAppPool" />
      </iis:WebSite>
    </Component>

    <!-- PowerShell Script for Advanced Credential Configuration -->
    <Component Id="AppPoolCredentialScript" Directory="INSTALLFOLDER" Guid="FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF">
      <File Id="ConfigureCredentialScript" 
            Source="ConfigureAppPoolWithCredentials.ps1" 
            Name="ConfigureAppPoolWithCredentials.ps1" 
            KeyPath="yes" />
    </Component>

    <!-- Custom Actions for Credential Configuration -->
    
    <!-- Action for ApplicationPoolIdentity -->
    <?if $(var.AppPoolIdentity) = "applicationPoolIdentity" ?>
    <CustomAction Id="ConfigureAppPoolIdentity"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]ConfigureAppPoolWithCredentials.ps1&quot; -AppPoolName &quot;$(var.SiteName)AppPool&quot; -IdentityType &quot;ApplicationPoolIdentity&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <?endif?>
    
    <!-- Action for Custom User -->
    <?if $(var.AppPoolIdentity) = "other" ?>
    <CustomAction Id="ConfigureCustomUser"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]ConfigureAppPoolWithCredentials.ps1&quot; -AppPoolName &quot;$(var.SiteName)AppPool&quot; -IdentityType &quot;SpecificUser&quot; -UserName &quot;[APPPOOL_USER]&quot; -Password &quot;[APPPOOL_PASSWORD]&quot; -Domain &quot;[APPPOOL_DOMAIN]&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />
    <?endif?>

    <!-- Install Sequence -->
    <InstallExecuteSequence>
      <?if $(var.AppPoolIdentity) = "applicationPoolIdentity" ?>
        <Custom Action="ConfigureAppPoolIdentity" After="InstallFiles" Condition="NOT Installed" />
      <?endif?>
      <?if $(var.AppPoolIdentity) = "other" ?>
        <Custom Action="ConfigureCustomUser" After="InstallFiles" Condition="NOT Installed" />
      <?endif?>
    </InstallExecuteSequence>

    <!-- Feature to install -->
    <Feature Id="Complete" Title="$(var.SiteName) Website Installation" Level="1">
      <ComponentGroupRef Id="WebApplicationFiles" />
      <ComponentRef Id="CreateAppPool" />
      <ComponentRef Id="CreateWebSite" />
      <ComponentRef Id="AppPoolCredentialScript" />
    </Feature>

  </Package>
</Wix>